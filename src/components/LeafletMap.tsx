
import React, { useState, useEffect, useRef } from 'react';
import { useTheme } from 'next-themes';
import { MapContainer, TileLayer, Marker, Popup } from 'react-leaflet';
import 'leaflet/dist/leaflet.css';
import L from 'leaflet';
import HeatmapLayer from 'react-leaflet-heatmap-layer';

// Import marker images as data URIs to avoid file resolution issues
const redMarker = 'data:image/png;base64,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';
const yellowMarker = 'data:image/png;base64,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';
const greenMarker = 'data:image/png;base64,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';
